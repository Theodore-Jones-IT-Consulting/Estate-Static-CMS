<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Editor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/grapesjs/0.16.18/grapes.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/2.0.0/marked.min.js"></script>
    <style>
        #markdown-editor, #html-editor { margin-top: 20px; }
        #markdown-content { width: 100%; height: 200px; }
        #markdown-preview { border: 1px solid #ddd; padding: 10px; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mt-4 mb-4">Content Editor</h1>
        <div id="editor-container">
            <div class="form-group">
                <label for="file-selector">Select File:</label>
                <select id="file-selector" class="form-control" onchange="loadFile()">
                    <!-- Options will be populated here -->
                </select>
            </div>
            <button class="btn btn-primary" onclick="createFile()">Create New</button>
            <button class="btn btn-danger" onclick="deleteFile()">Delete</button>
            
            <div id="markdown-editor" style="display:none;">
                <h2>Markdown Editor</h2>
                <textarea id="markdown-content" class="form-control"></textarea>
                <div id="markdown-preview" class="mt-3"></div>
            </div>

            <div id="html-editor" style="display:none;">
                <h2>HTML Editor</h2>
                <!-- GrapesJS or simple code editor will be initialized here -->
            </div>
        </div>
    </div>

    <script>
document.addEventListener("DOMContentLoaded", function() {
    loadFileList();
});

function loadFileList() {
    $.ajax({
        url: '/pages', // Adjust URL as per your Flask routes
        type: 'GET',
        success: function(files) {
            const fileSelector = $('#file-selector');
            fileSelector.empty();
            files.forEach(file => {
                fileSelector.append(new Option(file, file));
            });
        },
        error: function(error) {
            console.error("Error loading files: ", error);
        }
    });
}

function loadFile() {
    const selectedFile = $('#file-selector').val();
    const fileType = selectedFile.split('.').pop();

    $.ajax({
        url: '/pages/' + selectedFile, // Adjust URL as per your Flask routes
        type: 'GET',
        success: function(data) {
            if (fileType === 'md') {
                $('#markdown-editor').show();
                $('#html-editor').hide();
                $('#markdown-content').val(data);
                $('#markdown-preview').html(marked(data));
            } else if (fileType === 'html') {
                $('#markdown-editor').hide();
                $('#html-editor').show();
                initHtmlEditor(data);
            }
        },
        error: function(error) {
            console.error("Error loading file: ", error);
        }
    });
}

function createFile() {
    const fileName = prompt("Enter the file name:");
    const fileType = prompt("Enter the file type (md/html):");

    if (!fileName || !fileType) {
        alert("File name and type are required.");
        return;
    }

    $.ajax({
        url: '/pages/create',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ name: fileName, type: fileType }),
        success: function(response) {
            console.log(response.message);
            loadFileList();
        },
        error: function(error) {
            console.error("Error creating file: ", error);
            alert("Error creating file: " + error.responseText);
        }
    });
}

function deleteFile() {
    const selectedFile = $('#file-selector').val();

    $.ajax({
        url: '/pages/' + selectedFile, // Adjust URL as per your Flask routes
        type: 'DELETE',
        success: function(response) {
            console.log(response.message);
            loadFileList();
        },
        error: function(error) {
            console.error("Error deleting file: ", error);
        }
    });
}

function initHtmlEditor(htmlContent) {
    // Initialize GrapesJS editor
    const editor = grapesjs.init({
        container: '#html-editor',
        fromElement: true,
        clearOnRender: true,
        height: '300px',
        storageManager: {
            id: 'gjs-',             
            type: 'local',          
            autosave: true,         
            autoload: true,         
            stepsBeforeSave: 1,     
        },
        components: htmlContent
    });

    // Initialize the Bootstrap plugin
    editor.PluginManager.add('gjs-plugin-bootstrap', editor => {
        // Add Bootstrap components to the block manager
        const blockManager = editor.BlockManager;

        // Example of adding a Bootstrap button
        blockManager.add('bootstrap-button', {
            label: 'Button',
            content: '<button type="button" class="btn btn-primary">Button</button>',
            category: 'Bootstrap',
        });

        // Additional Bootstrap components can be added here
    });

    // Run the Bootstrap plugin
    editor.PluginManager.get('gjs-plugin-bootstrap').run(editor);
}

function saveChanges() {
    const selectedFile = $('#file-selector').val();
    const fileType = selectedFile.split('.').pop();
    let data;

    if (fileType === 'md') {
        data = $('#markdown-content').val();
    } else if (fileType === 'html') {
        // Retrieve HTML content from GrapesJS
        const editor = grapesjs.getEditor(); // Assuming a single instance
        data = editor.getHtml();
    }

    $.ajax({
        url: '/pages/' + selectedFile, // Adjust URL as per your Flask routes
        type: 'PUT',
        contentType: 'text/plain',
        data: data,
        success: function(response) {
            console.log(response.message);
        },
        error: function(error) {
            console.error("Error saving file: ", error);
        }
    });
}

// Markdown Editor Event Listener
$('#markdown-content').on('input', function() {
    const markdownContent = $(this).val();
    $('#markdown-preview').html(marked(markdownContent));
});

    </script>
</body>
</html>
