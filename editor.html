<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Editor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/2.0.0/marked.min.js"></script>
<!-- Include the GrapesJS script -->
<script src="https://unpkg.com/grapesjs"></script>
<script src="https://unpkg.com/grapesjs-preset-mautic"></script>
<script src="https://unpkg.com/grapesjs-blocks-basic"></script>
<script src="https://unpkg.com/grapesjs-blocks-flexbox"></script>

    <style>
        #markdown-editor, #html-editor { margin-top: 20px; }
        #markdown-content { width: 100%; height: 200px; }
        #markdown-preview { border: 1px solid #ddd; padding: 10px; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mt-4 mb-4">Content Editor</h1>
        <div id="editor-container">
            <div class="form-group">
                <label for="file-selector">Select File:</label>
                <select id="file-selector" class="form-control" onchange="loadFile()">
                    <!-- Options will be populated here -->
                </select>
            </div>
            <button class="btn btn-primary" onclick="createFile()">Create New</button>
            <button class="btn btn-danger" onclick="deleteFile()">Delete</button>
            
            <div id="markdown-editor" style="display:none;">
                <h2>Markdown Editor</h2>
                <textarea id="markdown-content" class="form-control"></textarea>
                <div id="markdown-preview" class="mt-3"></div>
                <button class="btn btn-primary mt-2" onclick="saveMarkdown()">Save</button> <!-- Save button -->
            </div>
            <div id="html-editor" style="display:none;">
                <h2>HTML Editor</h2>
                <div id="gjs-html-editor">
                    <!-- GrapesJS Editor will be initialized in this div -->
                </div>
                <button class="btn btn-primary mt-2" onclick="saveHtmlContent()">Save HTML</button>
            </div>
            
        </div>
    </div>

    <script>
document.addEventListener("DOMContentLoaded", function() {
    loadFileList();
});

function loadFileList() {
    $.ajax({
        url: '/pages', // Adjust URL as per your Flask routes
        type: 'GET',
        success: function(files) {
            const fileSelector = $('#file-selector');
            fileSelector.empty();
            files.forEach(file => {
                fileSelector.append(new Option(file, file));
            });

            if (files.length > 0) {
                // Load the first file by default
                fileSelector.val(files[0]).change();
            }
        },
        error: function(error) {
            console.error("Error loading files: ", error);
        }
    });
}

function loadFile() {
    const selectedFile = $('#file-selector').val();
    const fileType = selectedFile.split('.').pop();

    $.ajax({
        url: '/pages/' + selectedFile,
        type: 'GET',
        success: function(response) {
            if (fileType === 'md') {
                $('#markdown-editor').show();
                $('#html-editor').hide();
                $('#markdown-content').val(response.content);
                $('#markdown-preview').html(marked(response.content));
            } else if (fileType === 'html') {
                $('#markdown-editor').hide();
                $('#html-editor').show();

                if (!editor) {
                    initHtmlEditor(response.content);
                } else {
                    editor.setComponents(response.content);
                }
            }
        },
        error: function(error) {
            console.error("Error loading file: ", error);
        }
    });
}

function createFile() {
    const fileName = prompt("Enter the file name:");
    const fileType = prompt("Enter the file type (md/html):");

    if (!fileName || !fileType) {
        alert("File name and type are required.");
        return;
    }

    $.ajax({
        url: '/pages/create',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ name: fileName, type: fileType }),
        success: function(response) {
            console.log(response.message);
            loadFileList();
        },
        error: function(error) {
            console.error("Error creating file: ", error);
            alert("Error creating file: " + error.responseText);
        }
    });
}

function saveHtmlContent() {
    const selectedFile = $('#file-selector').val();
    const htmlContent = editor.getHtml() + '<style>' + editor.getCss() + '</style>';

    $.ajax({
        url: '/pages/' + selectedFile,
        type: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify({ content: htmlContent }),
        success: function(response) {
            alert("HTML content saved successfully!");
            console.log(response.message);
        },
        error: function(error) {
            console.error("Error saving HTML content: ", error);
            alert("Error saving HTML content: " + error.responseText);
        }
    });
}

function deleteFile() {
    const selectedFile = $('#file-selector').val();

    $.ajax({
        url: '/pages/' + selectedFile, // Adjust URL as per your Flask routes
        type: 'DELETE',
        success: function(response) {
            console.log(response.message);
            loadFileList();
        },
        error: function(error) {
            console.error("Error deleting file: ", error);
        }
    });
}
// Global variable to hold the GrapesJS editor instance
var editor = null;

function initHtmlEditor(htmlContent) {
    // Make sure that htmlContent is not null or undefined
    htmlContent = htmlContent || '';

    // Check if the GrapesJS editor is already initialized
    if (!editor) {
        // Initialize GrapesJS editor with the given content
        editor = grapesjs.init({
            container: '#gjs-html-editor',
            fromElement: true,
            clearOnRender: true,
            height: '600px',
            storageManager: false, // Disable the default storage manager
            components: htmlContent,
            plugins: ['grapesjs-preset-mautic', 'gjs-blocks-basic', 'grapesjs-blocks-flexbox'] , // Correct plugin names
            pluginsOpts: {
                'grapesjs-preset-mautic': {},
                'gjs-blocks-basic': {}, 
                'grapesjs-blocks-flexbox': {}
                // Plugin options here, if needed
            }
        });
    } else {
        // If already initialized, just update the contents
        editor.setComponents(htmlContent);
    }
}


function saveMarkdown() {
    const selectedFile = $('#file-selector').val();
    const markdownContent = $('#markdown-content').val();

    $.ajax({
        url: '/pages/' + selectedFile, // Adjust URL as per your Flask routes
        type: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify({ content: markdownContent }), // Send as JSON
        success: function(response) {
            alert("Markdown content saved successfully!");
            console.log(response.message);
        },
        error: function(error) {
            console.error("Error saving markdown content: ", error);
            alert("Error saving markdown content: " + error.responseText);
        }
    });
}

function saveChanges() {
    const selectedFile = $('#file-selector').val();
    const fileType = selectedFile.split('.').pop();
    let data;

    if (fileType === 'md') {
        data = $('#markdown-content').val();
    } else if (fileType === 'html') {
        data = editor.getHtml() + '<style>' + editor.getCss() + '</style>'; // Get HTML and CSS from GrapesJS editor
    }

    $.ajax({
        url: '/pages/' + selectedFile,
        type: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify({ content: data }), // Send content in JSON format
        success: function(response) {
            alert("Content saved successfully!");
            console.log(response.message);
        },
        error: function(error) {
            console.error("Error saving content: ", error);
            alert("Error saving content: " + error.responseText);
        }
    });
}

// Markdown Editor Event Listener
$('#markdown-content').on('input', function() {
    const markdownContent = $(this).val();
    $('#markdown-preview').html(marked(markdownContent));
});

document.addEventListener("DOMContentLoaded", function() {
    loadFileList();
});

    </script>
</body>
</html>
